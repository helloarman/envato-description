<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cabby Shop Finder</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Inter', sans-serif;
            overflow: hidden;
            background-color: #f9f9f9;
        }

        /* --- Map Styles --- */
        .leaflet-layer {
            filter: grayscale(80%) brightness(105%);
        }
        
        /* Hide default zoom controls */
        .leaflet-control-container .leaflet-top {
            display: none;
        }

        /* --- Custom Animations --- */
        @keyframes pulse-ring {
            0% { transform: scale(0.33); opacity: 1; }
            80%, 100% { transform: scale(1); opacity: 0; }
        }

        /* --- Marker Styles --- */
        .user-marker-container {
            pointer-events: none;
        }
        .user-location-marker {
            background-color: #FFD400; /* Brand Yellow */
            border: 2px solid white;
            border-radius: 50%;
            box-shadow: 0 0 5px rgba(0,0,0,0.3);
            width: 20px; 
            height: 20px;
        }
        .pulse-ring {
            position: absolute;
            height: 40px;
            width: 40px;
            border-radius: 50%;
            background-color: rgba(255, 212, 0, 0.5);
            animation: pulse-ring 2s cubic-bezier(0.215, 0.61, 0.355, 1) infinite;
            top: -10px;
            left: -10px;
            z-index: -1;
        }

        .custom-shop-pin {
            background-color: #111111; /* Brand Black */
            border-radius: 50%;
            border: 2px solid #fff;
            box-shadow: 0px 4px 12px rgba(0,0,0,0.2);
            display: flex !important;
            align-items: center;
            justify-content: center;
        }

        /* --- Utilities --- */
        .fade-in-up {
            animation: fadeInUp 0.3s ease-out forwards;
        }
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="h-screen w-full relative bg-gray-50">

    <!-- Map Container -->
    <div id="map" class="absolute inset-0 z-0"></div>

    <!-- Top Navigation Bar -->
    <div class="absolute top-0 left-0 right-0 z-[1000] px-4 pt-4 pb-2 bg-gradient-to-b from-white/90 to-transparent pointer-events-none">
        <div class="flex items-center justify-between pointer-events-auto">
            <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-2 flex items-center gap-3 px-4 h-14 w-full max-w-md mx-auto">
                <i data-lucide="menu" class="text-gray-400 w-6 h-6"></i>
                <div class="flex-1">
                    <p class="text-[10px] text-gray-400 font-medium uppercase tracking-wider">Current Area</p>
                    <h1 class="text-sm font-bold text-gray-900 leading-tight">London, UK</h1>
                </div>
                <div class="bg-[#FFD400] w-10 h-10 rounded-xl flex items-center justify-center shadow-[0_4px_12px_rgba(255,212,0,0.3)]">
                    <i data-lucide="user" class="text-black w-5 h-5"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Floating Action Button (I am here) -->
    <div class="absolute bottom-24 right-4 z-[900] flex flex-col gap-3 pointer-events-auto">
        <button 
            id="btn-reset-view"
            class="bg-white w-11 h-11 rounded-xl shadow-lg flex items-center justify-center active:scale-95 transition-transform"
        >
            <i data-lucide="navigation" class="w-5 h-5 text-gray-700"></i>
        </button>

        <button 
            id="btn-locate"
            class="bg-[#111111] text-white px-5 py-3 rounded-2xl shadow-xl flex items-center gap-2 active:scale-95 transition-transform"
        >
            <div class="w-2 h-2 rounded-full bg-[#FFD400] animate-pulse"></div>
            <span class="font-semibold text-sm">I am here</span>
        </button>
    </div>

    <!-- Shop Details Container (Floating Card) -->
    <div id="bottom-sheet-container" class="absolute bottom-0 left-0 right-0 z-[1000] pointer-events-none">
        <div class="px-4 pb-[88px] pointer-events-auto">
            <div id="panel-content">
                <!-- Shop Content injected here -->
            </div>
        </div>
    </div>

    <!-- User Location Sheet (Half Page Modal) -->
    <div id="user-sheet" class="fixed bottom-0 left-0 right-0 bg-white z-[1100] rounded-t-[32px] shadow-[0_-10px_40px_rgba(0,0,0,0.15)] transform translate-y-full transition-transform duration-300 ease-out h-[50vh] flex flex-col pointer-events-auto">
        <div class="p-6 flex flex-col h-full relative">
            
            <!-- Drag Handle -->
            <div class="w-12 h-1.5 bg-gray-200 rounded-full mx-auto mb-6 shrink-0"></div>
            
            <!-- Close Button -->
            <button onclick="clearPanel()" class="absolute top-6 right-6 p-2 bg-gray-50 rounded-full hover:bg-gray-100 transition-colors">
                <i data-lucide="x" class="w-5 h-5 text-gray-400"></i>
            </button>

            <!-- Status Header -->
            <div class="flex items-center gap-3 mb-4 shrink-0">
                <div class="relative">
                    <div class="w-3 h-3 bg-[#2ECC71] rounded-full"></div>
                    <div class="absolute inset-0 bg-[#2ECC71] rounded-full animate-ping opacity-75"></div>
                </div>
                <span class="text-sm font-bold text-[#2ECC71] uppercase tracking-wider">Live Location Sharing</span>
            </div>

            <!-- Main Content -->
            <div class="flex-1 overflow-y-auto mb-4">
                <h2 id="user-sheet-title" class="text-2xl font-bold text-[#111111] mb-2 leading-tight">Locating...</h2>
                <p id="user-sheet-address" class="text-base text-gray-500 leading-relaxed">Fetching coordinates...</p>
                
                <div class="mt-6 p-4 bg-gray-50 rounded-2xl border border-gray-100 flex items-center gap-4">
                    <div class="w-10 h-10 rounded-full bg-white flex items-center justify-center border border-gray-200 text-gray-400">
                        <i data-lucide="clock" class="w-5 h-5"></i>
                    </div>
                    <div>
                        <p class="text-xs text-gray-400 font-medium uppercase">Active For</p>
                        <p class="text-sm font-bold text-gray-900">Just now</p>
                    </div>
                </div>
            </div>

            <!-- Actions -->
            <div class="shrink-0 flex gap-3 mt-auto">
                <button class="flex-1 bg-[#FFD400] text-[#111111] h-[56px] rounded-2xl font-bold text-base shadow-[0_8px_20px_rgba(255,212,0,0.3)] active:translate-y-0.5 transition-transform flex items-center justify-center gap-2">
                    <i data-lucide="share-2" class="w-5 h-5"></i>
                    Share Live Link
                </button>
                <button class="flex-1 bg-white border border-gray-200 text-[#E74C3C] h-[56px] rounded-2xl font-bold text-base active:bg-gray-50 transition-colors">
                    Stop Sharing
                </button>
            </div>
        </div>
    </div>

    <!-- Bottom Navigation Bar -->
    <div class="absolute bottom-0 w-full h-[72px] bg-white border-t border-gray-100 flex items-center justify-around z-[1000] rounded-t-3xl shadow-[0_-4px_20px_rgba(0,0,0,0.03)] pointer-events-auto">
        <button class="flex flex-col items-center justify-center gap-1 w-16 group">
            <i data-lucide="home" class="w-6 h-6 text-[#111111] fill-[#FFD400]"></i>
            <div class="w-1 h-1 bg-[#111111] rounded-full mt-1"></div>
        </button>
        <button class="flex flex-col items-center justify-center gap-1 w-16 group">
            <i data-lucide="map" class="w-6 h-6 text-gray-400 group-hover:text-gray-600"></i>
        </button>
        <div class="w-12"></div> <!-- Spacer -->
        <button class="flex flex-col items-center justify-center gap-1 w-16 group">
            <i data-lucide="heart" class="w-6 h-6 text-gray-400 group-hover:text-gray-600"></i>
        </button>
        <button class="flex flex-col items-center justify-center gap-1 w-16 group">
            <i data-lucide="user" class="w-6 h-6 text-gray-400 group-hover:text-gray-600"></i>
        </button>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <script>
        // --- Configuration & Data ---
        const COLORS = {
            primary: "#FFD400",
            secondary: "#111111",
            text: "#1A1A1A"
        };

        const MOCK_SHOPS = [
            { id: 1, name: "Bean & Brew", category: "Coffee Shop", rating: 4.8, lat: 51.505, lng: -0.09, distance: "0.2 km", type: "cafe" },
            { id: 2, name: "Urban Threads", category: "Fashion", rating: 4.5, lat: 51.507, lng: -0.08, distance: "0.5 km", type: "shop" },
            { id: 3, name: "Tech Point", category: "Electronics", rating: 4.9, lat: 51.503, lng: -0.10, distance: "0.8 km", type: "shop" },
            { id: 4, name: "Green Grocer", category: "Organic Food", rating: 4.6, lat: 51.509, lng: -0.095, distance: "1.1 km", type: "food" },
        ];

        // --- State ---
        let map;
        let userMarker = null;
        let userCircle = null;
        let selectedShopId = null;

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            initMap();
            renderShops();
            setupEventListeners();
            lucide.createIcons();
        });

        function initMap() {
            map = L.map('map', {
                zoomControl: false,
                attributionControl: false
            }).setView([51.505, -0.09], 14);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '© OpenStreetMap'
            }).addTo(map);

            // Handle map click to clear selection
            map.on('click', () => {
                clearPanel();
            });
        }

        function renderShops() {
            MOCK_SHOPS.forEach(shop => {
                const iconHtml = `
                    <div style="display: flex; align-items: center; justify-content: center; width: 100%; height: 100%;">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#FFD400" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                            <polyline points="9 22 9 12 15 12 15 22"></polyline>
                        </svg>
                    </div>
                `;

                const icon = L.divIcon({
                    className: 'custom-shop-pin',
                    html: iconHtml,
                    iconSize: [32, 32],
                    iconAnchor: [16, 32]
                });

                L.marker([shop.lat, shop.lng], { icon: icon })
                    .addTo(map)
                    .on('click', (e) => {
                        L.DomEvent.stopPropagation(e);
                        selectShop(shop);
                    });
            });
        }

        function setupEventListeners() {
            document.getElementById('btn-locate').addEventListener('click', handleLocateMe);
            document.getElementById('btn-reset-view').addEventListener('click', () => {
                map.flyTo([51.505, -0.09], 14);
                clearPanel();
            });
        }

        // --- Core Logic ---

        function handleLocateMe() {
            if (!navigator.geolocation) {
                alert("Geolocation is not supported by your browser");
                return;
            }

            // Immediately show the half-sheet in "loading" state
            showUserPanel(true, "Locating...");

            navigator.geolocation.getCurrentPosition(
                async (position) => {
                    const { latitude, longitude, accuracy } = position.coords;
                    const latLng = [latitude, longitude];

                    if (userMarker) map.removeLayer(userMarker);
                    if (userCircle) map.removeLayer(userCircle);

                    const userIcon = L.divIcon({
                        className: 'user-marker-container',
                        html: `<div class="pulse-ring"></div><div class="user-location-marker"></div>`,
                        iconSize: [20, 20],
                        iconAnchor: [10, 10]
                    });

                    userMarker = L.marker(latLng, { icon: userIcon }).addTo(map);
                    userCircle = L.circle(latLng, {
                        radius: accuracy,
                        color: COLORS.primary,
                        weight: 1,
                        opacity: 0.4,
                        fillOpacity: 0.1
                    }).addTo(map);

                    // Offset map slightly to account for the half-sheet
                    map.flyTo(latLng, 16, { paddingBottomRight: [0, 300] });

                    try {
                        const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${latitude}&lon=${longitude}`);
                        const data = await response.json();
                        showUserPanel(false, data.display_name || "Unknown Location");
                    } catch (error) {
                        showUserPanel(false, "Location found (Address unavailable)");
                    }
                },
                () => {
                    alert("Unable to retrieve location");
                    clearPanel();
                },
                { enableHighAccuracy: true }
            );
        }

        function selectShop(shop) {
            selectedShopId = shop.id;
            
            // Close user sheet if open
            document.getElementById('user-sheet').classList.add('translate-y-full');
            
            map.flyTo([shop.lat, shop.lng], 16, { paddingBottomRight: [0, 200] });

            const content = document.getElementById('panel-content');
            content.innerHTML = `
                <div class="bg-white rounded-[24px] p-5 shadow-[0_12px_32px_rgba(0,0,0,0.15)] fade-in-up">
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <span class="text-[10px] font-bold text-[#FFD400] bg-black px-2 py-1 rounded-md uppercase tracking-wider mb-2 inline-block">
                                ${shop.category}
                            </span>
                            <h2 class="text-2xl font-bold text-[#111111] leading-none">${shop.name}</h2>
                        </div>
                        <div class="flex flex-col items-end">
                            <div class="flex items-center gap-1 bg-gray-50 px-2 py-1 rounded-lg">
                                <i data-lucide="star" class="w-3 h-3 text-orange-400 fill-orange-400"></i>
                                <span class="text-xs font-bold text-gray-800">${shop.rating}</span>
                            </div>
                            <span class="text-xs text-gray-400 mt-1">${shop.distance} away</span>
                        </div>
                    </div>
                    
                    <p class="text-sm text-gray-500 mb-5">Open until 9:00 PM • Dine-in • Takeaway</p>

                    <div class="flex gap-3">
                        <button class="flex-1 bg-[#111111] text-white h-[52px] rounded-2xl font-semibold text-sm shadow-lg active:translate-y-0.5 transition-transform">
                            View Products
                        </button>
                        <button class="flex-1 bg-white border border-gray-200 text-[#111111] h-[52px] rounded-2xl font-semibold text-sm active:bg-gray-50 transition">
                            Get Directions
                        </button>
                    </div>
                </div>
            `;
            lucide.createIcons();
        }

        function showUserPanel(isLoading, addressText) {
            // Close any existing shop panel
            document.getElementById('panel-content').innerHTML = '';
            
            // Show the half-sheet
            const sheet = document.getElementById('user-sheet');
            sheet.classList.remove('translate-y-full');

            const titleEl = document.getElementById('user-sheet-title');
            const addrEl = document.getElementById('user-sheet-address');

            if (isLoading) {
                titleEl.textContent = "Locating...";
                addrEl.textContent = "Fetching your current position...";
            } else {
                titleEl.textContent = "Your Location";
                addrEl.textContent = addressText;
            }
        }

        function clearPanel() {
            // Clear shop panel
            document.getElementById('panel-content').innerHTML = '';
            
            // Hide user sheet
            document.getElementById('user-sheet').classList.add('translate-y-full');
            
            selectedShopId = null;
        }

        // Expose to window for inline onclick
        window.clearPanel = clearPanel;

    </script>
</body>
</html>